<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autostereogram Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better touch interaction */
        canvas {
            touch-action: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style disabled elements */
        select:disabled, input[type="range"]:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Autostereogram Generator</h1>
            <p class="text-gray-600 mt-2">Create your own 'Magic Eye' 3D images by drawing.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Panel: Controls & Drawing Canvas -->
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">1. Draw a Depth Map</h2>
                <p class="text-sm text-gray-500 mb-4">
                    Draw on the canvas below. <strong>Darker areas will appear closer</strong> to you, and lighter areas will be further away. The white background is the farthest point.
                </p>
                <!-- Removed aspect-ratio classes for JS control -->
                <div class="w-full bg-gray-200 rounded-lg overflow-hidden">
                    <canvas id="drawingCanvas" class="w-full h-full cursor-crosshair border-2 border-gray-300 rounded-md"></canvas>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-between mt-4 gap-4">
                    <div class="flex items-center space-x-3 w-full sm:w-auto">
                        <label for="brushSize" class="text-sm font-medium text-gray-700">Brush:</label>
                        <input type="range" id="brushSize" min="1" max="80" value="30" class="w-full">
                    </div>
                    <button id="clearBtn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                        Clear Canvas
                    </button>
                </div>
            </div>

            <!-- Right Panel: Output -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">2. Generate & View</h2>
                
                <!-- Generation Options -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label for="patternStyle" class="block text-sm font-medium text-gray-700 mb-1">Pattern Style</label>
                        <select id="patternStyle" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="color-dots">Random Color Dots</option>
                            <option value="bw-dots">Black & White Dots</option>
                        </select>
                    </div>
                    <div>
                        <label for="colorPalette" class="block text-sm font-medium text-gray-700 mb-1">Color Palette</label>
                        <select id="colorPalette" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="random">Full Random</option>
                            <option value="ocean">Ocean Blues</option>
                            <option value="forest">Forest Greens</option>
                            <option value="fire">Fiery Reds</option>
                            <option value="pastel">Pastel Dreams</option>
                        </select>
                    </div>
                    <div>
                        <label for="depthIntensity" class="block text-sm font-medium text-gray-700 mb-1">3D Depth Intensity</label>
                        <input type="range" id="depthIntensity" min="0.1" max="0.8" step="0.05" value="0.4" class="w-full">
                    </div>
                </div>

                <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 text-lg mb-4">
                    Generate Stereogram
                </button>
                <!-- Removed aspect-ratio classes for JS control -->
                <div id="outputContainer" class="w-full bg-gray-200 rounded-lg overflow-hidden relative">
                     <div id="placeholder" class="absolute inset-0 w-full h-full flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-md p-4">
                        <p class="text-gray-500 text-center">Your 3D image will appear here.</p>
                        <p class="text-gray-400 text-xs text-center mt-2">Draw on the left and click generate.</p>
                    </div>
                    <div id="loader" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 hidden">
                        <div class="loader"></div>
                        <p class="ml-4 text-gray-600">Generating...</p>
                    </div>
                    <canvas id="stereogramCanvas" class="w-full h-full hidden"></canvas>
                </div>
                <div id="instructions" class="mt-4 text-sm text-gray-600 hidden">
                    <h3 class="font-semibold text-gray-800">How to View the 3D Image:</h3>
                    <ol class="list-decimal list-inside mt-2 space-y-1">
                        <li>Bring your face close to the screen.</li>
                        <li>Relax your eyes and try to look "through" the image, as if focusing on something far behind it.</li>
                        <li>Slowly move your head away from the screen, keeping your eyes unfocused.</li>
                        <li>Be patient! The hidden 3D image should suddenly pop into view.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Selection ---
            const drawingCanvas = document.getElementById('drawingCanvas');
            const stereogramCanvas = document.getElementById('stereogramCanvas');
            const generateBtn = document.getElementById('generateBtn');
            const clearBtn = document.getElementById('clearBtn');
            const brushSizeSlider = document.getElementById('brushSize');
            const placeholder = document.getElementById('placeholder');
            const instructions = document.getElementById('instructions');
            const loader = document.getElementById('loader');
            const patternStyleSelect = document.getElementById('patternStyle');
            const colorPaletteSelect = document.getElementById('colorPalette');
            const depthIntensitySlider = document.getElementById('depthIntensity');

            const drawCtx = drawingCanvas.getContext('2d', { willReadFrequently: true });
            const stereoCtx = stereogramCanvas.getContext('2d');

            // --- State Variables ---
            let isDrawing = false;
            let brushSize = 30;
            let lastX = 0;
            let lastY = 0;

            // --- Color Palettes ---
            const colorPalettes = {
                ocean: [[0, 82, 122], [0, 123, 167], [120, 194, 217], [200, 230, 240]],
                forest: [[45, 87, 44], [90, 133, 89], [148, 184, 147], [210, 227, 209]],
                fire: [[140, 20, 0], [217, 54, 23], [242, 145, 28], [242, 219, 53]],
                pastel: [[255, 209, 220], [204, 229, 255], [255, 253, 204], [204, 255, 229]]
            };

            function getRandomColorFromPalette(paletteName) {
                if (!colorPalettes[paletteName]) return [0,0,0];
                const palette = colorPalettes[paletteName];
                return palette[Math.floor(Math.random() * palette.length)];
            }

            // --- Canvas Setup (FIXED) ---
            function setupCanvases() {
                const drawContainer = drawingCanvas.parentElement;
                const stereoContainer = document.getElementById('outputContainer');

                // Calculate dimensions based on the width of the drawing container to maintain a fixed aspect ratio
                const width = drawContainer.clientWidth;
                const height = width * (3 / 4); // Maintain a 4:3 aspect ratio

                // Set the dimensions for both the container and the canvas element
                // This prevents layout shifts and distortion by giving the containers a fixed height
                drawContainer.style.height = `${height}px`;
                stereoContainer.style.height = `${height}px`;

                // Set the canvas drawing surface resolution
                drawingCanvas.width = stereogramCanvas.width = width;
                drawingCanvas.height = stereogramCanvas.height = height;

                // Redraw the content after resizing
                clearDrawing();
            }

            // --- Drawing Logic ---
            function clearDrawing() {
                drawCtx.fillStyle = 'white';
                drawCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            }

            function getEventPosition(e) {
                const rect = drawingCanvas.getBoundingClientRect();
                const scaleX = drawingCanvas.width / rect.width;
                const scaleY = drawingCanvas.height / rect.height;

                if (e.touches && e.touches.length > 0) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                }
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }

            function startDrawing(e) {
                e.preventDefault(); isDrawing = true;
                const pos = getEventPosition(e);
                [lastX, lastY] = [pos.x, pos.y];
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getEventPosition(e);
                drawCtx.beginPath();
                drawCtx.moveTo(lastX, lastY);
                drawCtx.lineTo(pos.x, pos.y);
                drawCtx.strokeStyle = 'black';
                drawCtx.lineWidth = brushSize;
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                drawCtx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
            }

            function stopDrawing() { isDrawing = false; }

            // --- Stereogram Generation ---
            function generateStereogram() {
                loader.classList.remove('hidden');
                placeholder.style.display = 'none'; // Use display none to prevent layout contribution
                stereogramCanvas.classList.add('hidden');
                instructions.classList.add('hidden');
                generateBtn.disabled = true;

                setTimeout(() => {
                    try {
                        const width = drawingCanvas.width;
                        const height = drawingCanvas.height;
                        const drawImageData = drawCtx.getImageData(0, 0, width, height);
                        const depthMap = new Float32Array(width * height);
                        for (let i = 0; i < drawImageData.data.length; i += 4) {
                            depthMap[i / 4] = (255 - drawImageData.data[i]) / 255.0;
                        }

                        const stereoImageData = stereoCtx.createImageData(width, height);
                        const stereoData = stereoImageData.data;

                        const patternStyle = patternStyleSelect.value;
                        const colorPalette = colorPaletteSelect.value;
                        const mu = parseFloat(depthIntensitySlider.value);
                        const eyeSeparation = Math.floor(width / 10);

                        for (let y = 0; y < height; y++) {
                            const pixelColors = new Uint8Array(width * 3);

                            for (let x = 0; x < width; x++) {
                                const depthIndex = y * width + x;
                                const depth = depthMap[depthIndex];
                                const separation = Math.round((1 - mu * depth) * eyeSeparation);
                                const linkedX = x - separation;

                                let r, g, b;

                                if (linkedX < 0) {
                                    if (patternStyle === 'bw-dots') {
                                        const val = Math.random() > 0.5 ? 255 : 0;
                                        r = g = b = val;
                                    } else {
                                        if (colorPalette === 'random') {
                                            r = Math.floor(Math.random() * 256);
                                            g = Math.floor(Math.random() * 256);
                                            b = Math.floor(Math.random() * 256);
                                        } else {
                                            [r, g, b] = getRandomColorFromPalette(colorPalette);
                                        }
                                    }
                                } else {
                                    const linkedPixelColorIndex = linkedX * 3;
                                    r = pixelColors[linkedPixelColorIndex];
                                    g = pixelColors[linkedPixelColorIndex + 1];
                                    b = pixelColors[linkedPixelColorIndex + 2];
                                }
                                
                                const currentPixelColorIndex = x * 3;
                                pixelColors[currentPixelColorIndex] = r;
                                pixelColors[currentPixelColorIndex + 1] = g;
                                pixelColors[currentPixelColorIndex + 2] = b;

                                const finalImageIndex = depthIndex * 4;
                                stereoData[finalImageIndex] = r;
                                stereoData[finalImageIndex + 1] = g;
                                stereoData[finalImageIndex + 2] = b;
                                stereoData[finalImageIndex + 3] = 255;
                            }
                        }
                        stereoCtx.putImageData(stereoImageData, 0, 0);

                    } catch (error) {
                        console.error("Failed to generate stereogram:", error);
                    } finally {
                        loader.classList.add('hidden');
                        stereogramCanvas.classList.remove('hidden');
                        instructions.classList.remove('hidden');
                        generateBtn.disabled = false;
                    }
                }, 50);
            }
            
            // --- UI Logic ---
            function updateUI() {
                const isColor = patternStyleSelect.value === 'color-dots';
                colorPaletteSelect.disabled = !isColor;
            }

            // --- Event Listeners ---
            brushSizeSlider.addEventListener('input', (e) => brushSize = e.target.value);
            clearBtn.addEventListener('click', clearDrawing);
            generateBtn.addEventListener('click', generateStereogram);
            patternStyleSelect.addEventListener('change', updateUI);

            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseleave', stopDrawing);
            drawingCanvas.addEventListener('touchstart', startDrawing);
            drawingCanvas.addEventListener('touchmove', draw);
            drawingCanvas.addEventListener('touchend', stopDrawing);
            drawingCanvas.addEventListener('touchcancel', stopDrawing);

            // --- Initial Run ---
            setupCanvases();
            updateUI();
            window.addEventListener('resize', setupCanvases);
        });
    </script>
</body>
</html>
